<!DOCTYPE html>
<html>
<body>
<h2>CareBot (Ollama)</h2>

<input id="msg" placeholder="Type here..." />
<button onclick="send()">Send</button>

<ul id="chat"></ul>

<script>
const ws = new WebSocket("ws://localhost:8000/ws");
const chat = document.getElementById("chat");
let thinking = null;
let currentAssistantLi = null; // holds the <li> we stream text into

ws.onmessage = e => {
  const d = JSON.parse(e.data);

  if (d.type === "thinking") {
    // Starting a new response turn: reset any stale assistant bubble
    currentAssistantLi = null;

    // Show a single "Thinking..." item while backend works
    thinking = document.createElement("li");
    thinking.innerText = "ü§ñ Thinking...";
    chat.appendChild(thinking);
  }

  if (d.type === "stream") {
    // First streamed chunk: remove "Thinking..." and create an assistant bubble
    if (thinking) {
      thinking.remove();
      thinking = null;
    }

    if (!currentAssistantLi) {
      currentAssistantLi = document.createElement("li");
      currentAssistantLi.innerText = "ü§ñ ";
      chat.appendChild(currentAssistantLi);
    }

    // Append the next chunk so it feels token-by-token
    currentAssistantLi.innerText += d.content;
  }

  if (d.type === "final") {
    // Ensure the thinking indicator is cleared
    if (thinking) {
      thinking.remove();
      thinking = null;
    }

    // If for some reason we didn't stream, fall back to a single message
    if (!currentAssistantLi) {
      currentAssistantLi = document.createElement("li");
      currentAssistantLi.innerText = "ü§ñ " + d.content;
      chat.appendChild(currentAssistantLi);
    }

    currentAssistantLi = null; // conversation turn is complete
  }

  if (d.type === "error") {
    // Clear thinking and show a simple error line
    if (thinking) {
      thinking.remove();
      thinking = null;
    }

    // Also reset any partially-streamed assistant message so the
    // next reply starts fresh and does not append to old content.
    currentAssistantLi = null;

    const li = document.createElement("li");
    li.innerText = "‚ö†Ô∏è " + d.content;
    chat.appendChild(li);
  }
};

function send() {
  const i = document.getElementById("msg");
  if (!i.value.trim()) return;

  const li = document.createElement("li");
  li.innerText = "üßë " + i.value;
  chat.appendChild(li);

  ws.send(i.value);
  i.value = "";
}
</script>
</body>
</html>
